name: rfc-reusable-deploy

on:
  workflow_call:
    inputs:
      connector_version: # fex: 8.5.7 - 8.5 for Camunda release, 7 for connector version
        required: true
        type: string
      cf_api_endpoint:
        required: true
        type: string
      cf_org:
        required: true
        type: string
      cf_space:
        required: true
        type: string
    outputs:
      cluster_uuid:
        description: 'The UUID of the created Camunda Cloud cluster'
        value: ${{ jobs.create-cluster.outputs.cluster-uuid }}
      deployment_name:
        description: 'The name of the deployment'
        value: ${{ jobs.create-cluster.outputs.deployment-name }}

jobs:
  extract-version:
    runs-on: ubuntu-latest
    outputs:
        camunda_release: ${{ steps.extract_release.outputs.camunda_release }}
    steps:
      - name: extract release branch # first two digits of connector_version
        run: echo "camunda_release=$(echo ${{ inputs.connector_version }} | cut -d'.' -f1-2)" >> "$GITHUB_OUTPUT"
        id: extract_release

  create-cluster:
    runs-on: ubuntu-latest
    needs: extract-version
    outputs:
        cluster-uuid: ${{ steps.create_cluster.outputs.cluster-uuid }}
        deployment-name: ${{ steps.set_deployment_name.outputs.deployment-name }}
    steps:
      - name: Set deployment name
        id: set_deployment_name
        run: |
          # Create a unique deployment name using version, branch and run ID
          DEPLOYMENT_NAME="sap-rfc-connector-${{ inputs.connector_version }}-${{ github.ref_name }}-${{ github.run_id }}"
          # Sanitize the name to make it compatible with SAP BTP (replace invalid characters with hyphens)
          DEPLOYMENT_NAME=$(echo "$DEPLOYMENT_NAME" | sed 's/[^a-zA-Z0-9-]/-/g' | sed 's/--*/-/g' | sed 's/-$//' | cut -c1-50)
          echo "deployment-name=$DEPLOYMENT_NAME" >> "$GITHUB_OUTPUT"
          echo "Using deployment name: $DEPLOYMENT_NAME"
      - name: Import Secrets
        id: vault-secrets
        uses: hashicorp/vault-action@v3.0.0
        with:
          url: ${{ secrets.VAULT_ADDR }}
          method: approle
          roleId: ${{ secrets.VAULT_ROLE_ID }}
          secretId: ${{ secrets.VAULT_SECRET_ID}}
          secrets: |
            secret/data/products/connectors/ci/sap CONSOLE_CLIENT_ID;
            secret/data/products/connectors/ci/sap CONSOLE_CLIENT_SECRET;
      - name: Checkout repository
        uses: actions/checkout@v5
      - name: Create cluster
        id: create_cluster
        run: node scripts/manage_cluster.js values.json
        env:
          CONSOLE_CLIENT_ID: ${{ steps.vault-secrets.outputs.CONSOLE_CLIENT_ID }}
          CONSOLE_CLIENT_SECRET: ${{ steps.vault-secrets.outputs.CONSOLE_CLIENT_SECRET }}
          CAMUNDA_DESIRED_GENERATION: ${{ needs.extract-version.outputs.camunda_release }}
          CLUSTER_NAME: ${{ steps.set_deployment_name.outputs.deployment-name }}
      - name: Upload client config for e2e test
        uses: actions/upload-artifact@v5
        with:
          name: client-config
          path: values.json

      - name: fill in target cluster credentials
        run: |
          scripts/replace_mtad_placeholders.js \
          rfc-connector/mtad.yaml.example \
          "${{ inputs.connector_version }}" \
          "${{ steps.create_cluster.outputs.grpc-address }}" \
          "${{ steps.create_cluster.outputs.rest-address }}" \
          "${{ steps.create_cluster.outputs.client-id }}" \
          "${{ steps.create_cluster.outputs.client-secret }}" \
          "${{ steps.set_deployment_name.outputs.deployment-name }}"
          mv rfc-connector/mtad.yaml.example mtad.yaml

      # no worries: gh marks secrets with *** also when cat'ing files
      - name: check substitution result
        run: |
          cat mtad.yaml

      - name: Upload mtad.yaml
        uses: actions/upload-artifact@v5
        with:
          name: mtad
          path: mtad.yaml

  deploy:
    needs: create-cluster
    runs-on: ubuntu-latest

    steps:
      - name: install cf cli
        run: |
          # sudo apt-get update
          sudo apt-get install -y wget
          wget -q -O - https://packages.cloudfoundry.org/debian/cli.cloudfoundry.org.key | sudo apt-key add -
          echo "deb https://packages.cloudfoundry.org/debian stable main" | sudo tee /etc/apt/sources.list.d/cloudfoundry-cli.list
          # wget -q -O - https://packages.cloudfoundry.org/debian/cli.cloudfoundry.org.key | sudo gpg --dearmor -o /usr/share/keyrings/cli.cloudfoundry.org.gpg
          # echo "deb [signed-by=/usr/share/keyrings/cli.cloudfoundry.org.gpg] https://packages.cloudfoundry.org/debian stable main" | sudo tee /etc/apt/sources.list.d/cloudfoundry-cli.list
          sudo apt-get update
          sudo apt-get install -y cf8-cli
          cf install-plugin multiapps -f

      # first, build the connector
      - uses: actions/checkout@v5

      - name: set up jdk 21
        uses: actions/setup-java@v5
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

      - name: build
        run: mvn package -DskipTests # as we've run the tests in the previous job

      # second, prep deployment descriptor
      - name: download mtad.yaml
        uses: actions/download-artifact@v6
        with:
          name: mtad
          path: rfc-connector/
      - name: Import Secrets
        id: vault-secrets
        uses: hashicorp/vault-action@v3.0.0
        with:
          url: ${{ secrets.VAULT_ADDR }}
          method: approle
          roleId: ${{ secrets.VAULT_ROLE_ID }}
          secretId: ${{ secrets.VAULT_SECRET_ID}}
          secrets: |
            secret/data/products/connectors/ci/sap SAP_CLOUDFOUNDRY_EMAIL;
            secret/data/products/connectors/ci/sap SAP_CLOUDFOUNDRY_PASSWORD;
      # third, actual deployment
      - name: deploy ${{inputs.connector_version}} to BTP
        # download-artifact puts the file w/o subdir here
        run: |
          cd rfc-connector
          ls -al .
          ls -al target
          cf login -a ${{ inputs.cf_api_endpoint }} -u ${{ steps.vault-secrets.outputs.SAP_CLOUDFOUNDRY_EMAIL }} \
          -p ${{ steps.vault-secrets.outputs.SAP_CLOUDFOUNDRY_PASSWORD }} -o ${{ inputs.cf_org }} -s ${{ inputs.cf_space }}
          cf deploy ./ -f
